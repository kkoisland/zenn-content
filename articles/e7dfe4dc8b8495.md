---
title: "RTK Queryã®æ´»ç”¨: ãƒ•ãƒƒã‚¯ã‚’ä½¿ã†å ´åˆã¨é–¢æ•°ã‚’ä½¿ã†å ´åˆã®å®Ÿè£…ä¾‹"
emoji: "ğŸ‘"
type: "tech"
topics: ["javascript", "react", "redux", "hook", "rtk"]
published: true
---

Redux Toolkitã®RTK Queryã«ã¯ã€ãƒ•ãƒƒã‚¯ã‚’ä½¿ã†å ´åˆã¨é–¢æ•°ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹å ´åˆã®2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå­˜åœ¨ã™ã‚‹ã€‚

**ãƒ•ãƒƒã‚¯ã‚’ä½¿ã†å ´åˆ**: çŠ¶æ…‹ç®¡ç†ãŒç°¡å˜ã§ã€ã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ç›´æ¥åˆ©ç”¨ã§ãã‚‹ã€‚

**ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹å ´åˆ**: é«˜ã„æŸ”è»Ÿæ€§ã‚’æŒã¡ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå¤–ã§ã‚‚ä½¿ç”¨å¯èƒ½ã§ã‚ã‚Šã€è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«å¯¾å¿œã—ã‚„ã™ã„ã€‚

ãªãŠã€Redux Toolkitã§ã®ã€Œã‚¹ãƒ©ã‚¤ã‚¹ã€ã¯ä¸»ã«çŠ¶æ…‹ç®¡ç†ã‚’æ‹…å½“ã™ã‚‹ã€‚ä¸€æ–¹ã€RTK Queryã§ã®ã€Œã‚¹ãƒ©ã‚¤ã‚¹ã€ã¯APIå‘¼ã³å‡ºã—ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã‚’è¡Œã†ã€‚æ··ä¹±ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã®è¨˜äº‹ã§ã¯RTK Queryã®ã€Œã‚¹ãƒ©ã‚¤ã‚¹ã€ã‚’ã€ŒAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ã¨å‘¼ã¶ã“ã¨ã«ã™ã‚‹ã€‚


## 1. ãƒ•ãƒƒã‚¯ã‚’ä½¿ã†å ´åˆ: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®APIç®¡ç†ã®å®Ÿè£…ä¾‹

```tsx:counterApi.js
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

// APIå®šç¾©
const counterApi = createApi({
  reducerPath: 'counterApi',
  baseQuery: fetchBaseQuery({ baseUrl: '/api' }), //ãƒ™ãƒ¼ã‚¹URLã‚’æŒ‡å®š
  endpoints: (builder) => ({ //ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©
    //ä»¥ä¸‹ã§ã€ã‚¯ã‚¨ãƒªã¨ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©
    getCounter: builder.query({
      query: () => 'counter',
    }),
    incrementCounter: builder.mutation({
      query: (amount) => ({
        url: 'counter/increment',
        method: 'POST',
        body: { amount },
      }),
    }),
    decrementCounter: builder.mutation({
      query: (amount) => ({
        url: 'counter/decrement',
        method: 'POST',
        body: { amount },
      }),
    }),
  }),
});
//ãƒ•ãƒƒã‚¯ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‚ã“ã‚Œã‚‰ã®ãƒ•ãƒƒã‚¯ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã—ã¦ã€APIã¨ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã†
export const {
    useGetCounterQuery,
    useIncrementCounterMutation,
    useDecrementCounterMutation
} = counterApi;

export default counterApi;
```
```tsx:store.js
// ã‚¹ãƒˆã‚¢ã¸ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¿½åŠ 
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import countersReducer from './features/counters/countersSlice';
import counterApi from './counterApi'; // APIãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

const store = configureStore({ //ã‚¹ãƒˆã‚¢ã‚’ä½œæˆ
ã€€// APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ã‚’è¿½åŠ 
  reducer: {
    counters: countersReducer,
    [counterApi.reducerPath]: counterApi.reducer,
  },
  // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¿½åŠ 
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(counterApi.middleware),
});
//setupListenersã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚„ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
setupListeners(store.dispatch);

export default store;
```
### ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹æ³•
```tsx:CounterComponent.js
import React from 'react';
import {
    useGetCounterQuery,
    useIncrementCounterMutation,
    useDecrementCounterMutation }
from './counterApi';

const CounterComponent = () => {
  //useGetCounterQueryãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å€¤ã‚’å–å¾—ã™ã‚‹
  const { data, error, isLoading } = useGetCounterQuery();
  // ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹
  // ãƒ•ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã€å–å¾—ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  //ï¼ˆãƒ­ãƒ¼ãƒ‰ä¸­ã€æˆåŠŸã€å¤±æ•—ãªã©ï¼‰ãŒReduxã‚¹ãƒˆã‚¢å†…ã§ç®¡ç†ã•ã‚Œã‚‹ã€‚
  // ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã€ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
  const [incrementCounter] = useIncrementCounterMutation();
  const [decrementCounter] = useDecrementCounterMutation();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <div>Error: {error.message}</div>;
  }

  return (
    <div>
      <h1>Counter: {data?.value}</h1>
      <button onClick={() => incrementCounter(1)}>Increment</button>
      <button onClick={() => decrementCounter(1)}>Decrement</button>
    </div>
  );
};

export default CounterComponent;
```


## 2. é–¢æ•°ã‚’ä½¿ã†å ´åˆ: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®APIç®¡ç†ã®å®Ÿè£…ä¾‹
```tsx:counterApi.js
//... (ä¸Šè¨˜ã®counterApi.jsã¨åŒã˜)

// ãƒ•ãƒƒã‚¯ã®ä»£ã‚ã‚Šã«ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export const {
  getCounter,
  incrementCounter,
  decrementCounter
} = counterApi.endpoints;

export default counterApi;
```
```tsx:store.js
// ä¸Šè¨˜ã®store.jsã¨åŒã˜ã€‚
```
### é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹æ³•
```tsx:CounterComponent.js
import React, { useEffect } from 'react';
import { useDispatch } from 'react-redux';
import { counterApi } from './counterApi';

const CounterComponent = () => {
  const dispatch = useDispatch();

  useEffect(() => {
    // useEffectã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    const fetchCounter = async () => {
      const result = await
          // dispatchã‚’ä½¿ç”¨ã—ã¦APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
ã€€ã€€ã€€ã€€ã€€ã€€dispatch(counterApi.endpoints.getCounter.initiate());
    };

    fetchCounter();
  }, [dispatch]);

  const handleIncrement = async () => {
    const result = await
      // dispatchã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å€¤ã‚’å¤‰æ›´ã™ã‚‹
      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã®é–¢æ•° (initiate) ãŒdispatchã•ã‚Œã€ãã®çµæœã¯
      // RTK Queryã§å‡¦ç†ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè‡ªå‹•çš„ã«Reduxã®çŠ¶æ…‹ã«ä¿å­˜ã•ã‚Œã‚‹
      dispatch(counterApi.endpoints.incrementCounter.initiate(1));
  };

  const handleDecrement = async () => {
    const result = await
    ã€€// ï¼ˆåŒä¸Šï¼‰
      dispatch(counterApi.endpoints.decrementCounter.initiate(1));
    console.log(result.data);
  };

  return (
    <div>
      <h1>Counter Component</h1>
      <button onClick={handleIncrement}>Increment</button>
      <button onClick={handleDecrement}>Decrement</button>
    </div>
  );
};

export default CounterComponent;
```
